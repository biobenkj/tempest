#!/usr/bin/env python3
"""
Tempest CLI Entry Point

This script provides the main command-line interface for Tempest,
with modular subcommands for simulation, training, evaluation, and visualization.
"""

import sys
import os
import site
import importlib.util


def find_tempest_cli():
    """Find the tempest CLI module installation."""
    # Try to find tempest installation
    tempest_locations = [
        # Development install locations (parent directory for development)
        os.path.join(os.path.dirname(os.path.dirname(os.path.abspath(__file__))), 'tempest'),
        # Current directory structure
        os.path.join(os.path.dirname(os.path.abspath(__file__)), '..', 'tempest'),
        # Site packages locations
        *[os.path.join(sp, 'tempest') for sp in site.getsitepackages()],
        # User site packages
        os.path.join(site.getusersitepackages(), 'tempest') if site.getusersitepackages() else None,
    ]
    # find the cli.py
    cli_path = None
    for loc in tempest_locations:
        if loc and os.path.exists(loc):
            # Try the new CLI module first
            cli = os.path.join(loc, 'cli_new.py')
            if os.path.exists(cli):
                cli_path = cli
                break
    return cli_path


def main():
    """Main entry point."""
    # Special handling for help to avoid TensorFlow imports
    if '--help' in sys.argv or '-h' in sys.argv or len(sys.argv) == 1:
        # Don't suppress warnings for help
        pass
    else:
        # Check if debug mode is disabled
        if '--debug' not in sys.argv and os.getenv('TEMPEST_DEBUG', '0') != '1':
            # Suppress TensorFlow and other warnings before any imports
            os.environ['TF_CPP_MIN_LOG_LEVEL'] = '3'
            os.environ['TF_ENABLE_ONEDNN_OPTS'] = '0'
            os.environ.setdefault('TF_DISABLE_PLUGIN_REGISTRATION', '1')
            os.environ.setdefault('TF_ENABLE_DEPRECATION_WARNINGS', '0')
            os.environ.setdefault('TF_TRT_ALLOW_ENGINE_CACHING', '0')
            
            # Set up warning filters
            import warnings
            warnings.filterwarnings('ignore',
                                    category=UserWarning,
                                    module='tensorflow')
            
            # Configure logging to suppress TensorFlow messages
            import logging
            logging.getLogger('tensorflow').setLevel(logging.ERROR)
            logging.getLogger('tensorflow').propagate = False
    
    # Find and load the CLI module
    cli_path = find_tempest_cli()
    
    # Shouldn't really ever happen, but here anyway
    if not cli_path:
        print("Error: Could not find tempest installation!", file=sys.stderr)
        print("Please install tempest first or run from the package directory", file=sys.stderr)
        sys.exit(1)
    
    # Load the CLI module directly
    spec = importlib.util.spec_from_file_location("tempest_cli", cli_path)
    tempest_cli = importlib.util.module_from_spec(spec)
    
    # Add tempest directory to path so the CLI can find its imports
    sys.path.insert(0, os.path.dirname(cli_path))
    
    # Execute the module
    spec.loader.exec_module(tempest_cli)
    
    # Run the CLI main function
    tempest_cli.main()


if __name__ == '__main__':
    main()
