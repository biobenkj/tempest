#!/usr/bin/env python3
"""
Tempest command-line interface launcher

This script serves as the main entry point for the Tempest CLI,
finding and loading the appropriate CLI module from the installation.
"""

import sys
import os
import site
import importlib.util
from pathlib import Path


def suppress_tensorflow_logging():
    """Suppress TensorFlow verbose logging unless debug mode is enabled."""
    if '--debug' not in sys.argv and os.getenv('TEMPEST_DEBUG', '0') != '1':
        # Suppress TensorFlow C++ logging
        os.environ['TF_CPP_MIN_LOG_LEVEL'] = '3'
        os.environ['TF_ENABLE_ONEDNN_OPTS'] = '0'
        os.environ.setdefault('TF_DISABLE_PLUGIN_REGISTRATION', '1')
        os.environ.setdefault('TF_ENABLE_DEPRECATION_WARNINGS', '0')
        
        # Set up warning filters before imports
        import warnings
        warnings.filterwarnings("ignore")
        
        # Configure logging
        import logging
        logging.getLogger('tensorflow').setLevel(logging.ERROR)
        logging.getLogger('tensorflow').propagate = False


def find_tempest_cli():
    """Find the Tempest CLI module in various possible locations."""
    # Get the directory containing this script
    script_dir = Path(__file__).parent.resolve()
    
    # Possible locations for the tempest package
    tempest_locations = [
        # Development install - sibling to bin directory
        script_dir.parent / 'tempest',
        # Development install - current directory structure
        script_dir / '..' / 'tempest',
        # Direct path if script is in tempest/bin
        script_dir.parent if script_dir.name == 'bin' else None,
        # Site packages locations
        *[Path(sp) / 'tempest' for sp in site.getsitepackages()],
        # User site packages
        Path(site.getusersitepackages()) / 'tempest' if site.getusersitepackages() else None,
    ]
    
    # Look for the CLI module in each location
    for location in tempest_locations:
        if location and location.exists():
            # Check for CLI module files
            cli_candidates = [
                location / 'cli.py',
                location / 'cli_updated.py',
            ]
            
            for cli_path in cli_candidates:
                if cli_path.exists():
                    return cli_path
    
    return None


def main():
    """Main entry point that loads and runs the Tempest CLI."""
    # Check for version or help early
    if '--version' in sys.argv:
        print("Tempest version 2.0.0")
        sys.exit(0)
    
    if len(sys.argv) == 1 or (len(sys.argv) == 2 and sys.argv[1] in ['--help', '-h']):
        # Show basic help without loading the full CLI
        print("""
Tempest - Advanced sequence annotation with length-constrained CRFs

Usage: tempest <command> [options]

Commands:
  simulate    Generate synthetic sequence data
  train       Train Tempest models
  evaluate    Evaluate trained models
  visualize   Create visualizations
  compare     Compare multiple models
  combine     Combine models using ensemble methods
  demux       Demultiplex FASTQ files

Use 'tempest <command> --help' for detailed help on each command.

Global options:
  --version   Show version information
  --help      Show this help message
  --debug     Enable debug mode with verbose output
        """)
        sys.exit(0)
    
    # Suppress TensorFlow logging before any imports
    suppress_tensorflow_logging()
    
    # Find the CLI module
    cli_path = find_tempest_cli()
    
    if not cli_path:
        print("Error: Could not find Tempest CLI module!", file=sys.stderr)
        print("Please ensure Tempest is properly installed.", file=sys.stderr)
        print("\nTry one of the following:", file=sys.stderr)
        print("  pip install -e .", file=sys.stderr)
        print("  python setup.py install", file=sys.stderr)
        sys.exit(1)
    
    # Add the tempest directory to Python path
    tempest_dir = cli_path.parent
    sys.path.insert(0, str(tempest_dir))
    
    # Load the CLI module
    spec = importlib.util.spec_from_file_location("tempest_cli", cli_path)
    if spec and spec.loader:
        tempest_cli = importlib.util.module_from_spec(spec)
        spec.loader.exec_module(tempest_cli)
        
        # Run the CLI
        tempest_cli.main()
    else:
        print(f"Error: Could not load CLI module from {cli_path}", file=sys.stderr)
        sys.exit(1)


if __name__ == '__main__':
    main()
